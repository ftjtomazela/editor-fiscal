<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Nota Fiscal</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 12px;
            background-color: #f0f4f8;
            color: #333;
            font-size: 14px;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            background-color: white;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-radius: 8px;
            border-top: 5px solid #4285f4;
        }
        .header {
            display: flex;
            flex-direction: column;
            border-bottom: 2px solid #4285f4;
            padding-bottom: 15px;
            margin-bottom: 20px;
            background-color: #f8fbff;
            padding: 12px;
            border-radius: 6px;
        }
        @media (min-width: 768px) {
            body {
                padding: 20px;
                font-size: 16px;
            }
            .container {
                max-width: 850px;
                padding: 30px;
            }
            .header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        .header-info {
            margin-bottom: 15px;
        }
        .logo {
            max-width: 120px;
            margin: 0 auto 15px;
        }
        @media (min-width: 768px) {
            .logo {
                margin: 0;
                max-width: 150px;
            }
        }
        .info-block {
            margin-bottom: 20px;
            background-color: #fcfcfc;
            padding: 12px;
            border-radius: 6px;
            border-left: 3px solid #4285f4;
        }
        .info-row {
            display: flex;
            flex-direction: column;
            margin-bottom: 12px;
        }
        @media (min-width: 768px) {
            .info-row {
                flex-direction: row;
            }
        }
        .info-label {
            font-weight: 600;
            width: 100%;
            margin-bottom: 5px;
            color: #4285f4;
        }
        @media (min-width: 768px) {
            .info-label {
                width: 150px;
                flex-shrink: 0;
                margin-bottom: 0;
            }
        }
        .info-valor {
            flex-grow: 1;
        }
        .pedido-data-row {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }
        @media (min-width: 768px) {
            .pedido-data-row {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        .data-emissao-container {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }
        @media (min-width: 768px) {
            .data-emissao-container {
                margin-bottom: 0;
            }
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 20px 0;
            border-radius: 8px;
            overflow-x: auto;
            display: block;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
        }
        @media (min-width: 768px) {
            table {
                display: table;
                overflow-x: visible;
            }
        }
        th, td {
            border: none;
            border-bottom: 1px solid #e6e9ed;
            padding: 8px;
            text-align: left;
            font-size: 13px;
        }
        @media (min-width: 768px) {
            th, td {
                padding: 12px 15px;
                font-size: inherit;
            }
        }
        th {
            background-color: #4285f4;
            color: white;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        @media (min-width: 768px) {
            th {
                font-size: 14px;
            }
        }
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        tr:hover {
            background-color: #f1f6ff;
        }
        input, select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            transition: border-color 0.2s;
        }
        input:focus, select:focus {
            border-color: #4285f4;
            outline: none;
            box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
        }
        .total-row {
            font-weight: bold;
            background-color: #f1f6ff;
        }
        .button-row {
            margin-top: 30px;
            text-align: center;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        @media (min-width: 768px) {
            .button-row {
                flex-direction: row;
                justify-content: center;
                gap: 15px;
            }
        }
        button {
            background-color: #4285f4;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            letter-spacing: 0.5px;
            transition: all 0.2s;
            box-shadow: 0 2px 5px rgba(66, 133, 244, 0.3);
        }
        button:hover {
            background-color: #3367d6;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(66, 133, 244, 0.4);
        }
        .divider {
            border-top: 1px dashed #ccc;
            margin: 25px 0;
            position: relative;
        }
        .divider:before {
            content: "‚Ä¢";
            position: absolute;
            top: -10px;
            left: 50%;
            background: white;
            padding: 0 10px;
            color: #4285f4;
        }
        .editable {
            background-color: #f9fafe;
            border-radius: 4px;
            padding: 4px 8px;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .editable:hover {
            border-color: #b8d1ff;
            background-color: #f0f7ff;
        }
        .editable:focus {
            outline: none;
            border-color: #4285f4;
            background-color: #fff;
            box-shadow: 0 0 0 3px rgba(66, 133, 244, 0.2);
        }
        .product-row td:last-child,
        .product-row td:nth-last-child(2),
        .product-row td:nth-last-child(3) {
            text-align: right;
        }
        .numero-pedido-container {
            display: flex;
            align-items: center;
            background: #4285f4;
            color: white;
            padding: 8px 15px;
            border-radius: 30px;
            font-weight: bold;
        }
        .numero-pedido-label {
            margin-right: 10px;
        }
        #numero-pedido {
            background: white;
            color: #4285f4;
            padding: 2px 8px;
            border-radius: 15px;
            min-width: 40px;
            text-align: center;
        }
        #shareModal, #pedidosModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
        }
        .close {
            float: right;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
        }
        #sharableLink {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .pedidos-lista {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e6e9ed;
            border-radius: 4px;
            margin: 15px 0;
        }
        .pedido-item {
            padding: 10px 15px;
            border-bottom: 1px solid #e6e9ed;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
        }
        .pedido-item:hover {
            background-color: #f0f7ff;
        }
        .pedido-item:last-child {
            border-bottom: none;
        }
        .pedido-acoes {
            display: flex;
            gap: 10px;
        }
        .botao-acao {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            padding: 2px 8px;
            color: #4285f4;
            box-shadow: none;
        }
        .botao-acao:hover {
            color: #3367d6;
            background-color: #e6f0ff;
            border-radius: 4px;
            transform: none;
            box-shadow: none;
        }
        .botao-excluir {
            color: #ea4335;
        }
        .botao-excluir:hover {
            color: #d33426;
            background-color: #ffebee;
        }
        .sem-pedidos {
            text-align: center;
            padding: 20px;
            color: #777;
            font-style: italic;
        }
        .menu-superior {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .titulo-app {
            font-size: 20px;
            font-weight: bold;
            color: #4285f4;
        }
        .botoes-menu {
            display: flex;
            gap: 10px;
        }
        .botao-menu {
            background-color: #f1f6ff;
            color: #4285f4;
            border: 1px solid #b8d1ff;
            padding: 8px 12px;
            border-radius: 50px;
            font-size: 13px;
            box-shadow: none;
        }
        .botao-menu:hover {
            background-color: #e6f0ff;
            transform: none;
            box-shadow: none;
        }
        @media (min-width: 768px) {
            .botao-menu {
                padding: 8px 16px;
                font-size: 14px;
            }
        }
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #4caf50;
            color: white;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            z-index: 1100;
            transform: translateY(-100px);
            opacity: 0;
            transition: all 0.3s;
        }
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        .notification.error {
            background-color: #f44336;
        }
        
        /* Estilos para impress√£o */
        @media print {
            body {
                background-color: white;
                padding: 0;
                margin: 0;
                font-size: 12px;
                color: black;
            }
            
            .menu-superior,
            .button-row,
            .botao-acao,
            button,
            .editable:hover,
            .editable:focus {
                display: none !important;
            }
            
            .container {
                box-shadow: none;
                border: none;
                padding: 20px;
                margin: 0;
                max-width: none;
                width: 100%;
            }
            
            .header {
                background-color: white;
                border-bottom: 2px solid black;
            }
            
            .info-block {
                background-color: white;
                border-left: none;
                padding: 10px 0;
            }
            
            .editable {
                background-color: white;
                border: none;
                padding: 0;
            }
            
            table {
                box-shadow: none;
                border: 1px solid black;
            }
            
            th, td {
                border: 1px solid black;
                padding: 5px;
                font-size: 11px;
            }
            
            th {
                background-color: #f0f0f0;
                color: black;
            }
            
            .divider {
                border-top: 1px solid black;
            }
            
            .divider:before {
                display: none;
            }
            
            .numero-pedido-container {
                background-color: white;
                color: black;
                border: 1px solid black;
            }
            
            #numero-pedido {
                background-color: white;
                color: black;
            }
            
            /* Ocultar linhas vazias na impress√£o */
            .info-row.hidden-print {
                display: none !important;
            }
            
            .product-row.hidden-print {
                display: none !important;
            }
            
            /* Ajustes para dispositivos m√≥veis na impress√£o */
            @page {
                margin: 1cm;
                size: A4;
            }
        }
    </style>
</head>
<body>
    <div class="menu-superior">
        <div class="titulo-app">
            Sistema de Notas Fiscais
        </div>
        <div class="botoes-menu">
            <button class="botao-menu" onclick="mostrarPedidos()">Meus Pedidos</button>
            <button class="botao-menu" onclick="novoPedido()">Novo Pedido</button>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-info">
                <h2 id="empresa-nome" contenteditable="true" class="editable">Tomazela Piscinas</h2>
                <p id="empresa-cnpj" contenteditable="true" class="editable">CNPJ: 40136528000107 IE: 271034122111</p>
                <p id="empresa-endereco" contenteditable="true" class="editable">Rua Romualdo Albino Balestrin, nro.35, Cohab III</p>
                <p id="empresa-cidade" contenteditable="true" class="editable">Conchas-SP</p>
                <p id="empresa-contato" contenteditable="true" class="editable">Fones: 14 3845-2887/14981722063</p>
                <p id="empresa-email" contenteditable="true" class="editable">E-mail: ftj230291@gmail.com</p>
            </div>
            <div>
                <img src="logo.png" alt="Logo" class="logo">
            </div>
        </div>

        <div class="info-block">
            <div class="pedido-data-row">
                <div class="data-emissao-container">
                    <span class="info-label">Data de Emiss√£o:</span>
                    <span id="data-emissao" class="info-valor">Carregando...</span>
                </div>
                <div class="numero-pedido-container">
                    <span class="numero-pedido-label">PEDIDO N¬∫:</span>
                    <span id="numero-pedido" contenteditable="true" class="editable">1</span>
                </div>
            </div>
        </div>

        <div class="divider"></div>

        <div class="info-block">
            <h3>Dados do Cliente</h3>
            <div class="info-row">
                <span class="info-label">Raz√£o Social:</span>
                <span id="cliente-razao" contenteditable="true" class="editable info-valor">59 Valdir</span>
            </div>
            <div class="info-row">
                <span class="info-label">Nome Fantasia:</span>
                <span id="cliente-fantasia" contenteditable="true" class="editable info-valor"></span>
            </div>
            <div class="info-row">
                <span class="info-label">Fones/E-mail:</span>
                <span id="cliente-contato" contenteditable="true" class="editable info-valor">//</span>
            </div>
            <div class="info-row">
                <span class="info-label">Logradouro:</span>
                <span id="cliente-logradouro" contenteditable="true" class="editable info-valor">, n¬∫</span>
            </div>
            <div class="info-row">
                <span class="info-label">Complemento:</span>
                <span id="cliente-complemento" contenteditable="true" class="editable info-valor"></span>
            </div>
            <div class="info-row">
                <span class="info-label">Bairro:</span>
                <span id="cliente-bairro" contenteditable="true" class="editable info-valor"></span>
            </div>
            <div class="info-row">
                <span class="info-label">Localidade:</span>
                <span id="cliente-localidade" contenteditable="true" class="editable info-valor">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">CEP:</span>
                <span id="cliente-cep" contenteditable="true" class="editable info-valor"></span>
            </div>
            <div class="info-row">
                <span class="info-label">CNPJ/CPF:</span>
                <span id="cliente-cnpj-cpf" contenteditable="true" class="editable info-valor"></span>
            </div>
            <div class="info-row">
                <span class="info-label">RG/IE:</span>
                <span id="cliente-rg-ie" contenteditable="true" class="editable info-valor"></span>
            </div>
            <div class="info-row">
                <span class="info-label">Emiss√£o:</span>
                <span id="cliente-emissao" class="editable info-valor"></span>
            </div>
            <div class="info-row">
                <span class="info-label">Forma de Cobran√ßa:</span>
                <span id="forma-cobranca" contenteditable="true" class="editable info-valor">Dinheiro</span>
            </div>
            <div class="info-row">
                <span class="info-label">Cond. Pagto:</span>
                <span id="cond-pagto" contenteditable="true" class="editable info-valor">√Ä Vista</span>
            </div>
            <div class="info-row">
                <span class="info-label">Tipo Frete:</span>
                <span id="tipo-frete" contenteditable="true" class="editable info-valor">CIF</span>
            </div>
            <div class="info-row">
                <span class="info-label">Vendedor:</span>
                <span id="vendedor" contenteditable="true" class="editable info-valor">Fernando</span>
            </div>
            <div class="info-row">
                <span class="info-label">Ord. Compra:</span>
                <span id="ord-compra" contenteditable="true" class="editable info-valor"></span>
            </div>
            <div class="info-row">
                <span class="info-label">Transportador:</span>
                <span id="transportador" contenteditable="true" class="editable info-valor"></span>
            </div>
            <div class="info-row">
                <span class="info-label">Entrega:</span>
                <span id="entrega" contenteditable="true" class="editable info-valor"></span>
            </div>
            <div class="info-row">
                <span class="info-label">Observa√ß√µes:</span>
                <span id="observacoes" contenteditable="true" class="editable info-valor"></span>
            </div>
            <div class="info-row">
                <span class="info-label">Tabela:</span>
                <span id="tabela" contenteditable="true" class="editable info-valor"></span>
            </div>
        </div>

        <div class="divider"></div>

        <table id="produtos-table">
            <thead>
                <tr>
                    <th>C√≥digo</th>
                    <th>Descri√ß√£o</th>
                    <th>Unid.</th>
                    <th>Qtde.</th>
                    <th>Vlr. Unit.</th>
                    <th>Desconto</th>
                    <th>Vlr. Total</th>
                    <th>A√ß√µes</th>
                </tr>
            </thead>
            <tbody id="produtos-tbody">
                <tr class="product-row" data-id="1">
                    <td contenteditable="true" class="editable">27</td>
                    <td contenteditable="true" class="editable">Cloro</td>
                    <td contenteditable="true" class="editable">1kg</td>
                    <td contenteditable="true" class="editable" onblur="recalcularTotal(this)">1</td>
                    <td contenteditable="true" class="editable" onblur="recalcularTotal(this)">199,00</td>
                    <td contenteditable="true" class="editable" onblur="recalcularTotal(this)">0,00</td>
                    <td contenteditable="true" class="editable">199,00</td>
                    <td>
                        <button type="button" onclick="excluirProduto(this)" style="padding: 5px; background-color: #f44336;">X</button>
                    </td>
                </tr>
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="6" style="text-align: right;"><strong>Total:</strong></td>
                    <td id="total-valor" style="text-align: right;"><strong>199,00</strong></td>
                    <td></td>
                </tr>
            </tfoot>
        </table>

        <div class="button-row">
            <button type="button" onclick="adicionarProduto()">Adicionar Produto</button>
            <button type="button" onclick="salvarPedido()">Salvar Pedido</button>
            <button type="button" onclick="compartilhar()">Compartilhar</button>
            <button type="button" onclick="imprimirNotaFiscal()">Imprimir</button>
        </div>
    </div>

    <div id="shareModal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal('shareModal')">&times;</span>
            <h3>Compartilhar Nota Fiscal</h3>
            <p>Use o link abaixo para compartilhar esta nota fiscal:</p>
            <input type="text" id="sharableLink" readonly>
            <div class="button-row">
                <button type="button" onclick="copiarLink()">Copiar Link</button>
                <button type="button" onclick="compartilharWhatsApp()">Compartilhar no WhatsApp</button>
                <button type="button" onclick="compartilharEmail()">Compartilhar por E-mail</button>
            </div>
        </div>
    </div>

    <div id="pedidosModal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal('pedidosModal')">&times;</span>
            <h3>Meus Pedidos</h3>
            <div class="pedidos-lista" id="listaPedidos">
                <!-- Os pedidos ser√£o carregados dinamicamente aqui -->
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>

    <script>
        // Constantes e vari√°veis globais
        const STORAGE_KEY = 'notasFiscaisPedidos';
        let proximoNumeroPedido = 1;
        
        // Fun√ß√£o para formatar valores monet√°rios
        function formatarMoeda(valor) {
            const num = parseFloat(valor) || 0;
            return num.toFixed(2).replace('.', ',');
        }

        // Fun√ß√£o para adicionar um novo produto
        function adicionarProduto() {
            const tbody = document.getElementById('produtos-tbody');
            const rowId = tbody.children.length + 1;
            
            const novaLinha = document.createElement('tr');
            novaLinha.className = 'product-row';
            novaLinha.dataset.id = rowId;
            
            novaLinha.innerHTML = `
                <td contenteditable="true" class="editable"></td>
                <td contenteditable="true" class="editable"></td>
                <td contenteditable="true" class="editable"></td>
                <td contenteditable="true" class="editable" onblur="recalcularTotal(this)">1</td>
                <td contenteditable="true" class="editable" onblur="recalcularTotal(this)">0,00</td>
                <td contenteditable="true" class="editable" onblur="recalcularTotal(this)">0,00</td>
                <td contenteditable="true" class="editable">0,00</td>
                <td>
                    <button type="button" onclick="excluirProduto(this)" style="padding: 5px; background-color: #f44336;">X</button>
                </td>
            `;
            
            tbody.appendChild(novaLinha);
            atualizarTotalGeral();
        }

        // Fun√ß√£o para excluir um produto
        function excluirProduto(botao) {
            const linha = botao.closest('tr');
            if (confirm('Deseja realmente excluir este produto?')) {
                linha.remove();
                atualizarTotalGeral();
            }
        }

        // Fun√ß√£o para recalcular o total de um produto
        function recalcularTotal(elemento) {
            const linha = elemento.closest('tr');
            const quantidade = parseFloat(linha.cells[3].textContent.replace(',', '.')) || 0;
            const valorUnitario = parseFloat(linha.cells[4].textContent.replace(',', '.')) || 0;
            const desconto = parseFloat(linha.cells[5].textContent.replace(',', '.')) || 0;
            
            const valorTotal = (quantidade * valorUnitario) - desconto;
            linha.cells[6].textContent = formatarMoeda(valorTotal);
            
            atualizarTotalGeral();
        }

        // Fun√ß√£o para atualizar o total geral
        function atualizarTotalGeral() {
            const linhas = document.querySelectorAll('.product-row');
            let totalGeral = 0;
            
            linhas.forEach(linha => {
                const valorTotal = parseFloat(linha.cells[6].textContent.replace(',', '.')) || 0;
                totalGeral += valorTotal;
            });
            
            document.getElementById('total-valor').textContent = formatarMoeda(totalGeral);
        }

        // Fun√ß√£o para compartilhar
        function compartilhar() {
            try {
                const dadosNotaFiscal = coletarDadosNotaFiscal();
                const dadosJSON = JSON.stringify(dadosNotaFiscal);
                const dadosEncoded = encodeURIComponent(dadosJSON);
                const link = `${window.location.origin}${window.location.pathname}?data=${dadosEncoded}`;
                
                document.getElementById('sharableLink').value = link;
                document.getElementById('shareModal').style.display = 'block';
            } catch (error) {
                console.error('Erro ao compartilhar:', error);
                mostrarNotificacao('Erro ao gerar link de compartilhamento', 'error');
            }
        }

        // Fun√ß√£o para coletar todos os dados da nota fiscal
        function coletarDadosNotaFiscal() {
            const dadosEmpresa = {
                nome: document.getElementById('empresa-nome').textContent || '',
                cnpj: document.getElementById('empresa-cnpj').textContent || '',
                endereco: document.getElementById('empresa-endereco').textContent || '',
                cidade: document.getElementById('empresa-cidade').textContent || '',
                contato: document.getElementById('empresa-contato').textContent || '',
                email: document.getElementById('empresa-email').textContent || ''
            };

            const dadosPedido = {
                dataEmissao: document.getElementById('data-emissao').textContent || '',
                numeroPedido: document.getElementById('numero-pedido').textContent || ''
            };

            const dadosCliente = {
                razaoSocial: document.getElementById('cliente-razao').textContent || '',
                nomeFantasia: document.getElementById('cliente-fantasia').textContent || '',
                contato: document.getElementById('cliente-contato').textContent || '',
                logradouro: document.getElementById('cliente-logradouro').textContent || '',
                complemento: document.getElementById('cliente-complemento').textContent || '',
                bairro: document.getElementById('cliente-bairro').textContent || '',
                localidade: document.getElementById('cliente-localidade').textContent || '',
                cep: document.getElementById('cliente-cep').textContent || '',
                cnpjCpf: document.getElementById('cliente-cnpj-cpf').textContent || '',
                rgIe: document.getElementById('cliente-rg-ie').textContent || '',
                emissao: document.getElementById('cliente-emissao').textContent || ''
            };

            const dadosPagamento = {
                formaCobranca: document.getElementById('forma-cobranca').textContent || '',
                condPagto: document.getElementById('cond-pagto').textContent || '',
                tipoFrete: document.getElementById('tipo-frete').textContent || '',
                ordCompra: document.getElementById('ord-compra').textContent || '',
                vendedor: document.getElementById('vendedor').textContent || '',
                transportador: document.getElementById('transportador').textContent || '',
                entrega: document.getElementById('entrega').textContent || '',
                observacoes: document.getElementById('observacoes').textContent || '',
                tabela: document.getElementById('tabela').textContent || ''
            };

            const produtos = [];
            const linhasProdutos = document.querySelectorAll('.product-row');
            
            linhasProdutos.forEach(linha => {
                if (linha.cells && linha.cells.length >= 7) {
                    const produto = {
                        codigo: linha.cells[0].textContent || '',
                        descricao: linha.cells[1].textContent || '',
                        unidade: linha.cells[2].textContent || '',
                        quantidade: linha.cells[3].textContent || '',
                        valorUnitario: linha.cells[4].textContent || '',
                        desconto: linha.cells[5].textContent || '',
                        valorTotal: linha.cells[6].textContent || ''
                    };
                    produtos.push(produto);
                }
            });

            const valorTotal = document.getElementById('total-valor').textContent || '';

            return {
                empresa: dadosEmpresa,
                pedido: dadosPedido,
                cliente: dadosCliente,
                pagamento: dadosPagamento,
                produtos: produtos,
                total: valorTotal
            };
        }

        // Fun√ß√£o para atualizar a data e hora de emiss√£o
        function atualizarDataHora() {
            try {
                const agora = new Date();
                
                const dia = String(agora.getDate()).padStart(2, '0');
                const mes = String(agora.getMonth() + 1).padStart(2, '0');
                const ano = agora.getFullYear();
                
                const hora = String(agora.getHours()).padStart(2, '0');
                const minutos = String(agora.getMinutes()).padStart(2, '0');
                const segundos = String(agora.getSeconds()).padStart(2, '0');
                
                const dataHoraFormatada = `${dia}/${mes}/${ano} ${hora}:${minutos}:${segundos}`;
                
                const elementoDataEmissao = document.getElementById('data-emissao');
                const elementoClienteEmissao = document.getElementById('cliente-emissao');
                
                if (elementoDataEmissao) {
                    elementoDataEmissao.textContent = dataHoraFormatada;
                }
                if (elementoClienteEmissao) {
                    elementoClienteEmissao.textContent = `${dia}/${mes}/${ano} ${hora}:${minutos}`;
                }
                
                setTimeout(atualizarDataHora, 1000);
            } catch (error) {
                console.error('Erro ao atualizar data/hora:', error);
            }
        }

        // Fun√ß√£o para carregar dados da URL se existirem
        function carregarDadosDaURL() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const dadosEncoded = urlParams.get('data');
                
                if (dadosEncoded) {
                    const dadosJSON = decodeURIComponent(dadosEncoded);
                    const dados = JSON.parse(dadosJSON);
                    preencherFormulario(dados);
                }
            } catch (error) {
                console.error("Erro ao carregar dados da URL:", error);
                mostrarNotificacao("Erro ao carregar dados do link", "error");
            }
        }

        // Fun√ß√£o para preencher o formul√°rio com os dados recebidos
        function preencherFormulario(dados) {
            try {
                if (dados.empresa) {
                    const elementos = {
                        'empresa-nome': dados.empresa.nome,
                        'empresa-cnpj': dados.empresa.cnpj,
                        'empresa-endereco': dados.empresa.endereco,
                        'empresa-cidade': dados.empresa.cidade,
                        'empresa-contato': dados.empresa.contato,
                        'empresa-email': dados.empresa.email
                    };
                    
                    Object.entries(elementos).forEach(([id, valor]) => {
                        const elemento = document.getElementById(id);
                        if (elemento && valor) elemento.textContent = valor;
                    });
                }

                if (dados.pedido) {
                    const elementoData = document.getElementById('data-emissao');
                    const elementoPedido = document.getElementById('numero-pedido');
                    
                    if (elementoData && dados.pedido.dataEmissao) {
                        elementoData.textContent = dados.pedido.dataEmissao;
                    }
                    if (elementoPedido && dados.pedido.numeroPedido) {
                        elementoPedido.textContent = dados.pedido.numeroPedido;
                    }
                }

                if (dados.cliente) {
                    const elementosCliente = {
                        'cliente-razao': dados.cliente.razaoSocial,
                        'cliente-fantasia': dados.cliente.nomeFantasia,
                        'cliente-contato': dados.cliente.contato,
                        'cliente-logradouro': dados.cliente.logradouro,
                        'cliente-complemento': dados.cliente.complemento,
                        'cliente-bairro': dados.cliente.bairro,
                        'cliente-localidade': dados.cliente.localidade,
                        'cliente-cep': dados.cliente.cep,
                        'cliente-cnpj-cpf': dados.cliente.cnpjCpf,
                        'cliente-rg-ie': dados.cliente.rgIe,
                        'cliente-emissao': dados.cliente.emissao
                    };
                    
                    Object.entries(elementosCliente).forEach(([id, valor]) => {
                        const elemento = document.getElementById(id);
                        if (elemento && valor) elemento.textContent = valor;
                    });
                }

                if (dados.pagamento) {
                    const elementosPagamento = {
                        'forma-cobranca': dados.pagamento.formaCobranca,
                        'cond-pagto': dados.pagamento.condPagto,
                        'tipo-frete': dados.pagamento.tipoFrete,
                        'ord-compra': dados.pagamento.ordCompra,
                        'vendedor': dados.pagamento.vendedor,
                        'transportador': dados.pagamento.transportador,
                        'entrega': dados.pagamento.entrega,
                        'observacoes': dados.pagamento.observacoes,
                        'tabela': dados.pagamento.tabela
                    };
                    
                    Object.entries(elementosPagamento).forEach(([id, valor]) => {
                        const elemento = document.getElementById(id);
                        if (elemento && valor) elemento.textContent = valor;
                    });
                }

                if (dados.produtos && Array.isArray(dados.produtos)) {
                    const tbody = document.getElementById('produtos-tbody');
                    if (tbody) {
                        tbody.innerHTML = '';
                        
                        dados.produtos.forEach((produto, index) => {
                            const novaLinha = document.createElement('tr');
                            novaLinha.className = 'product-row';
                            novaLinha.dataset.id = index + 1;
                            
                            novaLinha.innerHTML = `
                                <td contenteditable="true" class="editable">${produto.codigo || ''}</td>
                                <td contenteditable="true" class="editable">${produto.descricao || ''}</td>
                                <td contenteditable="true" class="editable">${produto.unidade || ''}</td>
                                <td contenteditable="true" class="editable" onblur="recalcularTotal(this)">${produto.quantidade || '1'}</td>
                                <td contenteditable="true" class="editable" onblur="recalcularTotal(this)">${produto.valorUnitario || '0,00'}</td>
                                <td contenteditable="true" class="editable" onblur="recalcularTotal(this)">${produto.desconto || '0,00'}</td>
                                <td contenteditable="true" class="editable">${produto.valorTotal || '0,00'}</td>
                                <td>
                                    <button type="button" onclick="excluirProduto(this)" style="padding: 5px; background-color: #f44336;">X</button>
                                </td>
                            `;
                            
                            tbody.appendChild(novaLinha);
                        });
                        
                        atualizarTotalGeral();
                    }
                }
            } catch (error) {
                console.error('Erro ao preencher formul√°rio:', error);
                mostrarNotificacao('Erro ao carregar dados', 'error');
            }
        }

        // Fun√ß√£o para imprimir a nota fiscal
        function imprimirNotaFiscal() {
            try {
                prepararParaImpressao();
                setTimeout(() => {
                    window.print();
                    setTimeout(restaurarVisualizacao, 1000);
                }, 100);
            } catch (error) {
                console.error('Erro ao imprimir:', error);
                mostrarNotificacao('Erro ao preparar impress√£o', 'error');
            }
        }
        
        // Fun√ß√£o para preparar o documento para impress√£o
        function prepararParaImpressao() {
            const infosRows = document.querySelectorAll('.info-row');
            infosRows.forEach(row => {
                const campos = row.querySelectorAll('.editable, .info-valor');
                let temConteudo = false;
                
                campos.forEach(campo => {
                    const texto = campo.textContent.trim();
                    if (texto && texto !== '/' && texto !== '//' && texto !== '-' && texto !== ', n¬∫' && texto !== '.' && texto !== ':') {
                        temConteudo = true;
                    }
                });
                
                if (!temConteudo) {
                    row.classList.add('hidden-print');
                } else {
                    row.classList.remove('hidden-print');
                }
            });
            
            const produtoRows = document.querySelectorAll('.product-row');
            produtoRows.forEach(row => {
                const descricao = row.cells[1] ? row.cells[1].textContent.trim() : '';
                const codigo = row.cells[0] ? row.cells[0].textContent.trim() : '';
                
                if (!descricao && !codigo) {
                    row.classList.add('hidden-print');
                } else {
                    row.classList.remove('hidden-print');
                }
            });
        }
        
        // Fun√ß√£o para restaurar a visualiza√ß√£o normal ap√≥s impress√£o
        function restaurarVisualizacao() {
            const elementosOcultos = document.querySelectorAll('.hidden-print');
            elementosOcultos.forEach(elemento => {
                elemento.classList.remove('hidden-print');
            });
        }
        
        // Fun√ß√£o para salvar o pedido
        function salvarPedido() {
            try {
                const dadosPedido = coletarDadosNotaFiscal();
                const numeroPedido = document.getElementById('numero-pedido').textContent;
                
                let pedidosSalvos = {};
                try {
                    pedidosSalvos = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                } catch (e) {
                    console.error('Erro ao ler localStorage:', e);
                    pedidosSalvos = {};
                }
                
                pedidosSalvos[numeroPedido] = {
                    dados: dadosPedido,
                    dataSalvo: new Date().toISOString(),
                    cliente: dadosPedido.cliente.razaoSocial || 'Cliente n√£o informado'
                };
                
                localStorage.setItem(STORAGE_KEY, JSON.stringify(pedidosSalvos));
                
                const numeroAtual = parseInt(numeroPedido) || 1;
                if (numeroAtual >= proximoNumeroPedido) {
                    proximoNumeroPedido = numeroAtual + 1;
                    localStorage.setItem('proximoNumeroPedido', proximoNumeroPedido.toString());
                }
                
                mostrarNotificacao('Pedido salvo com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao salvar pedido:', error);
                mostrarNotificacao('Erro ao salvar pedido', 'error');
            }
        }
        
        // Fun√ß√£o para mostrar a lista de pedidos
        function mostrarPedidos() {
            try {
                let pedidosSalvos = {};
                try {
                    pedidosSalvos = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                } catch (e) {
                    console.error('Erro ao ler pedidos:', e);
                }
                
                const listaPedidos = document.getElementById('listaPedidos');
                
                if (!listaPedidos) {
                    console.error('Elemento listaPedidos n√£o encontrado');
                    return;
                }
                
                if (Object.keys(pedidosSalvos).length === 0) {
                    listaPedidos.innerHTML = '<div class="sem-pedidos">Nenhum pedido salvo encontrado.</div>';
                } else {
                    let html = '';
                    
                    const pedidosOrdenados = Object.keys(pedidosSalvos).sort((a, b) => parseInt(b) - parseInt(a));
                    
                    pedidosOrdenados.forEach(numeroPedido => {
                        const pedido = pedidosSalvos[numeroPedido];
                        const dataSalvo = new Date(pedido.dataSalvo).toLocaleString('pt-BR');
                        
                        html += `
                            <div class="pedido-item">
                                <div>
                                    <strong>Pedido #${numeroPedido}</strong><br>
                                    <small>${pedido.cliente}</small><br>
                                    <small style="color: #777;">Salvo em: ${dataSalvo}</small>
                                </div>
                                <div class="pedido-acoes">
                                    <button class="botao-acao" onclick="carregarPedido('${numeroPedido}')" title="Carregar pedido">üìÑ</button>
                                    <button class="botao-acao" onclick="duplicarPedido('${numeroPedido}')" title="Duplicar pedido">üìã</button>
                                    <button class="botao-acao botao-excluir" onclick="excluirPedidoSalvo('${numeroPedido}')" title="Excluir pedido">üóëÔ∏è</button>
                                </div>
                            </div>
                        `;
                    });
                    
                    listaPedidos.innerHTML = html;
                }
                
                document.getElementById('pedidosModal').style.display = 'block';
            } catch (error) {
                console.error('Erro ao mostrar pedidos:', error);
                mostrarNotificacao('Erro ao carregar lista de pedidos', 'error');
            }
        }
        
        // Fun√ß√£o para carregar um pedido espec√≠fico
        function carregarPedido(numeroPedido) {
            try {
                const pedidosSalvos = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                
                if (pedidosSalvos[numeroPedido]) {
                    preencherFormulario(pedidosSalvos[numeroPedido].dados);
                    fecharModal('pedidosModal');
                    mostrarNotificacao(`Pedido #${numeroPedido} carregado!`, 'success');
                } else {
                    mostrarNotificacao('Pedido n√£o encontrado!', 'error');
                }
            } catch (error) {
                console.error('Erro ao carregar pedido:', error);
                mostrarNotificacao('Erro ao carregar pedido', 'error');
            }
        }
        
        // Fun√ß√£o para duplicar um pedido
        function duplicarPedido(numeroPedido) {
            try {
                const pedidosSalvos = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                
                if (pedidosSalvos[numeroPedido]) {
                    preencherFormulario(pedidosSalvos[numeroPedido].dados);
                    document.getElementById('numero-pedido').textContent = proximoNumeroPedido.toString();
                    atualizarDataHora();
                    
                    fecharModal('pedidosModal');
                    mostrarNotificacao(`Pedido #${numeroPedido} duplicado como #${proximoNumeroPedido}!`, 'success');
                } else {
                    mostrarNotificacao('Pedido n√£o encontrado!', 'error');
                }
            } catch (error) {
                console.error('Erro ao duplicar pedido:', error);
                mostrarNotificacao('Erro ao duplicar pedido', 'error');
            }
        }
        
        // Fun√ß√£o para excluir um pedido salvo
        function excluirPedidoSalvo(numeroPedido) {
            try {
                if (confirm(`Deseja realmente excluir o pedido #${numeroPedido}?`)) {
                    let pedidosSalvos = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
                    delete pedidosSalvos[numeroPedido];
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(pedidosSalvos));
                    
                    mostrarNotificacao(`Pedido #${numeroPedido} exclu√≠do!`, 'success');
                    mostrarPedidos();
                }
            } catch (error) {
                console.error('Erro ao excluir pedido:', error);
                mostrarNotificacao('Erro ao excluir pedido', 'error');
            }
        }
        
        // Fun√ß√£o para criar um novo pedido
        function novoPedido() {
            if (confirm('Deseja criar um novo pedido? Os dados n√£o salvos ser√£o perdidos.')) {
                limparFormulario();
                document.getElementById('numero-pedido').textContent = proximoNumeroPedido.toString();
                atualizarDataHora();
                mostrarNotificacao(`Novo pedido #${proximoNumeroPedido} criado!`, 'success');
            }
        }
        
        // Fun√ß√£o para limpar o formul√°rio
        function limparFormulario() {
            try {
                const camposLimpar = [
                    'cliente-razao', 'cliente-fantasia', 'cliente-contato', 'cliente-logradouro',
                    'cliente-complemento', 'cliente-bairro', 'cliente-localidade', 'cliente-cep',
                    'cliente-cnpj-cpf', 'cliente-rg-ie', 'ord-compra', 'transportador',
                    'entrega', 'observacoes', 'tabela'
                ];
                
                camposLimpar.forEach(id => {
                    const elemento = document.getElementById(id);
                    if (elemento) elemento.textContent = '';
                });
                
                const tbody = document.getElementById('produtos-tbody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr class="product-row" data-id="1">
                            <td contenteditable="true" class="editable"></td>
                            <td contenteditable="true" class="editable"></td>
                            <td contenteditable="true" class="editable"></td>
                            <td contenteditable="true" class="editable" onblur="recalcularTotal(this)">1</td>
                            <td contenteditable="true" class="editable" onblur="recalcularTotal(this)">0,00</td>
                            <td contenteditable="true" class="editable" onblur="recalcularTotal(this)">0,00</td>
                            <td contenteditable="true" class="editable">0,00</td>
                            <td>
                                <button type="button" onclick="excluirProduto(this)" style="padding: 5px; background-color: #f44336;">X</button>
                            </td>
                        </tr>
                    `;
                }
                
                atualizarTotalGeral();
            } catch (error) {
                console.error('Erro ao limpar formul√°rio:', error);
            }
        }
        
        // Fun√ß√£o para mostrar notifica√ß√µes
        function mostrarNotificacao(mensagem, tipo = 'success') {
            try {
                const notification = document.getElementById('notification');
                if (notification) {
                    notification.textContent = mensagem;
                    notification.className = `notification ${tipo} show`;
                    
                    setTimeout(() => {
                        notification.classList.remove('show');
                    }, 3000);
                }
            } catch (error) {
                console.error('Erro ao mostrar notifica√ß√£o:', error);
            }
        }

        // Fun√ß√£o para fechar o modal
        function fecharModal(modalId) {
            try {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.style.display = 'none';
                }
            } catch (error) {
                console.error('Erro ao fechar modal:', error);
            }
        }

        // Fun√ß√£o para copiar o link para a √°rea de transfer√™ncia
        function copiarLink() {
            try {
                const linkInput = document.getElementById('sharableLink');
                if (linkInput) {
                    linkInput.select();
                    linkInput.setSelectionRange(0, 99999);
                    
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(linkInput.value).then(() => {
                            mostrarNotificacao('Link copiado para a √°rea de transfer√™ncia!', 'success');
                        }).catch(() => {
                            document.execCommand('copy');
                            mostrarNotificacao('Link copiado!', 'success');
                        });
                    } else {
                        document.execCommand('copy');
                        mostrarNotificacao('Link copiado!', 'success');
                    }
                }
            } catch (error) {
                console.error('Erro ao copiar link:', error);
                mostrarNotificacao('Erro ao copiar o link', 'error');
            }
        }

        // Fun√ß√£o para compartilhar no WhatsApp
        function compartilharWhatsApp() {
            try {
                const link = document.getElementById('sharableLink').value;
                const clienteNome = document.getElementById('cliente-razao').textContent;
                const numeroPedido = document.getElementById('numero-pedido').textContent;
                
                const textoWhatsApp = `Nota Fiscal ${numeroPedido} para ${clienteNome}. Acesse: ${link}`;
                const whatsappLink = `https://wa.me/?text=${encodeURIComponent(textoWhatsApp)}`;
                
                window.open(whatsappLink, '_blank');
            } catch (error) {
                console.error('Erro ao compartilhar no WhatsApp:', error);
                mostrarNotificacao('Erro ao compartilhar no WhatsApp', 'error');
            }
        }

        // Fun√ß√£o para compartilhar por e-mail
        function compartilharEmail() {
            try {
                const link = document.getElementById('sharableLink').value;
                const clienteNome = document.getElementById('cliente-razao').textContent;
                const numeroPedido = document.getElementById('numero-pedido').textContent;
                
                const assunto = `Nota Fiscal ${numeroPedido} - ${clienteNome}`;
                const corpo = `Prezado cliente,\n\nSegue o link para acessar sua Nota Fiscal ${numeroPedido}:\n${link}\n\nAtenciosamente,\n${document.getElementById('empresa-nome').textContent}`;
                
                const mailtoLink = `mailto:?subject=${encodeURIComponent(assunto)}&body=${encodeURIComponent(corpo)}`;
                window.location.href = mailtoLink;
            } catch (error) {
                console.error('Erro ao compartilhar por email:', error);
                mostrarNotificacao('Erro ao compartilhar por email', 'error');
            }
        }

        // Event listeners para fechar modais clicando fora
        window.onclick = function(event) {
            try {
                const shareModal = document.getElementById('shareModal');
                const pedidosModal = document.getElementById('pedidosModal');
                
                if (event.target === shareModal) {
                    shareModal.style.display = 'none';
                }
                if (event.target === pedidosModal) {
                    pedidosModal.style.display = 'none';
                }
            } catch (error) {
                console.error('Erro no event listener:', error);
            }
        }

        // Fun√ß√£o para inicializar o sistema
        function inicializar() {
            try {
                proximoNumeroPedido = parseInt(localStorage.getItem('proximoNumeroPedido') || '1');
                
                const urlParams = new URLSearchParams(window.location.search);
                if (!urlParams.get('data')) {
                    const elementoPedido = document.getElementById('numero-pedido');
                    if (elementoPedido) {
                        elementoPedido.textContent = proximoNumeroPedido.toString();
                    }
                }
                
                atualizarDataHora();
                carregarDadosDaURL();
                
                console.log('Sistema inicializado com sucesso');
            } catch (error) {
                console.error('Erro ao inicializar sistema:', error);
            }
        }
        
        // Inicializar quando a p√°gina carregar
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', inicializar);
        } else {
            inicializar();
        }
    </script>
</body>
</html>
